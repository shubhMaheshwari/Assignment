<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-04-27 Thu 03:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Routing | Sessions | Structuring</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="VLEAD" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../style/css/worg-style.css" />
<link rel="stylesheet" type="text/css" href="../../style/css/override.css" />
<link rel="icon" type="image/png" href="../../style/img/favicon/popl.png" />
<script type="text/javascript" src="../../style/js/org-info.js">
/**
 *
 * @source: ../../style/js/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in ../../style/js/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in ../../style/js/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "1");
org_html_manager.set("LINK_HOME", "../../index.html");
org_html_manager.set("LINK_UP", "../index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../index.html"> UP </a>
 |
 <a accesskey="H" href="../../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Routing | Sessions | Structuring</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3dcc341">1. Objective of Lab</a></li>
<li><a href="#org6746ab7">2. ToDo application code</a></li>
<li><a href="#orgc007371">3. Structure of the Application</a>
<ul>
<li><a href="#org9ef5017">3.1. File descriptions</a></li>
<li><a href="#org36e08ed">3.2. Blueprints</a></li>
<li><a href="#orgf2a739b">3.3. index.html</a></li>
<li><a href="#org351f36e">3.4. Individual templates</a></li>
<li><a href="#org101ba78">3.5. Bringing all together</a></li>
</ul>
</li>
<li><a href="#org30a1f9b">4. Sessions</a></li>
<li><a href="#org556f94c">5. Routing</a>
<ul>
<li><a href="#org62a556f">5.1. routes.js</a></li>
</ul>
</li>
<li><a href="#org1063b07">6. Problems</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3dcc341" class="outline-2">
<h2 id="org3dcc341"><span class="section-number-2">1</span> Objective of Lab</h2>
<div class="outline-text-2" id="text-1">
<p>
Objective of the lab is to cover basic Front-end routing using
page.js, various concepts involved in maintaining sessions which
in turn help in authentication and a structured approach to create
a basic Todo application.
</p>
</div>
</div>

<div id="outline-container-org6746ab7" class="outline-2">
<h2 id="org6746ab7"><span class="section-number-2">2</span> ToDo application code</h2>
<div class="outline-text-2" id="text-2">
<p>
Code for today's lab can be found here - <code>https://gitlab.com/itws2-2017-spring-iiith-tas/todo-flask-application/</code>
</p>

<p>
Clone it and we will try to learn how it is built
</p>
</div>
</div>

<div id="outline-container-orgc007371" class="outline-2">
<h2 id="orgc007371"><span class="section-number-2">3</span> Structure of the Application</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-org9ef5017" class="outline-3">
<h3 id="org9ef5017"><span class="section-number-3">3.1</span> File descriptions</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>run.py &#x2013;&gt; The main python file which runs the server</li>
<li>config.py &#x2013;&gt; Sets the config for the Flask object</li>
<li>app/ &#x2013;&gt; All the code for the application (Controllers / Models / Views / Static files)</li>
<li>app/templates/ &#x2013;&gt; Contains only one index.html file which loads all the script files required for the application.
We are about to see an application that does not reload the pages on form submissions. Everything is handled by
javascript without explicit refreshing of pages. Only the html content of this <code>index.html</code> file is updated according
to the user action</li>
<li>app/static/ &#x2013;&gt; Contains external vendor's css and js files along with javascript routing code defined by us</li>
<li>app/static/templates/ &#x2013;&gt; Contains templates for the application which will be rendered into a div in the single <code>index.html</code> that we defined before</li>
<li>app/static/js/routes.js &#x2013;&gt; Front Routing is handled here. Which route invokes which js function is explicitly handled here. The syntax of this file is governed by page.js</li>
<li>app/static/js/helpers.js &#x2013;&gt; Defines a helper for form submission which prevents the default page load on submission of forms and instead performs an AJAX call according to the attributes provided in the html form and the form data.</li>
<li>app/todo/ &#x2013;&gt; Directory containing controllers and models for todo</li>
<li>app/user/ &#x2013;&gt; Directory containing controllers and models for user (Login / Logout handled here)</li>
<li>app/__init__.py &#x2013;&gt; Contains initializing for Flask object and handles importing of controllers and models from various modules defined above</li>
</ul>
</div>
</div>

<div id="outline-container-org36e08ed" class="outline-3">
<h3 id="org36e08ed"><span class="section-number-3">3.2</span> Blueprints</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Flask uses a concept of blueprints for making application components and supporting common patterns within an application or across applications. Blueprints can greatly simplify how large applications work and provide a central means for Flask extensions to register operations on applications. A Blueprint object works similarly to a Flask application object, but it is not actually an application. Rather it is a blueprint of how to construct or extend an application.</li>
<li>We use Blueprints to modularize our application and provide a url_prefix <code>/api</code> to every route that we define in the controller file.</li>
<li>There are many other reasons to use blueprints (<code>http://flask.pocoo.org/docs/0.12/blueprints/</code>)</li>
</ul>
</div>
</div>

<div id="outline-container-orgf2a739b" class="outline-3">
<h3 id="orgf2a739b"><span class="section-number-3">3.3</span> index.html</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>This is the default template that is loaded on every request. Instead of routing files from the backend we are aiming to perform frontend routing and hence we only render one html file once.</li>
<li>Any user action only changes the content of the html file and does not refresh the page.</li>
<li>Since this is the only page that is loaded, we need to load all the scripts in this page.</li>
</ul>
</div>
</div>

<div id="outline-container-org351f36e" class="outline-3">
<h3 id="org351f36e"><span class="section-number-3">3.4</span> Individual templates</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>Can be found in - <code>app/static/templates</code></li>
<li>We will put the contents of these templates in the main index.html according to user action.</li>
<li>Logic for this is handled by <code>view-manager.js</code> which internally invokes <code>auth-manager.js</code> and <code>todo-manager.js</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-org101ba78" class="outline-3">
<h3 id="org101ba78"><span class="section-number-3">3.5</span> Bringing all together</h3>
<div class="outline-text-3" id="text-3-5">
<ul class="org-ul">
<li>User requests a page.</li>
<li><code>routes.js</code> decides on the basis of this which js function needs to be called.</li>
<li>The manager js files then make the respective AJAX calls to the API defined in the backend</li>
<li>Backend performs the auth checks from the session object and authorizes the request
and returns the response based on the request.</li>
<li>This response is parsed by <code>view-manager.js</code> and then put in index.html</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org30a1f9b" class="outline-2">
<h2 id="org30a1f9b"><span class="section-number-2">4</span> Sessions</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Our final aim is to prevent certain endpoints / routes to be accessed from not-logged in users.</li>
<li>A session can be defined as a server-side storage of information that is desired to persist throughout the user's interaction with the web site or web application.</li>

<li>Instead of storing large and constantly changing information via cookies in the user's browser, only a unique identifier is stored on the client side (called a "session id"). This session id is passed to the web server every time the browser makes an HTTP request (ie a page link or AJAX request). The web application pairs this session id with it's internal database and retrieves the stored variables for use by the requested page.</li>

<li>When you work with an application, you open it, do some changes, and then you close it. This is much like a Session. The computer knows who you are. It knows when you start the application and when you end. But on the internet there is one problem: the web server does not know who you are or what you do, because the HTTP address doesn't maintain state. Session variables solve this problem by storing user information to be used across multiple pages (e.g. username, favorite color, etc). By default, session variables last until the user closes the browser.</li>

<li>Flask provides a <code>session</code> object inside which you can store various details about a particular session. In the Todo application you can see the usage of this object for login / logout in <code>app/users/controllers.py</code> file.</li>
</ul>

<p>
For login -
</p>
<pre class="example">
session['user_id'] = user.id
</pre>

<p>
For logout -
</p>
<pre class="example">
session.pop('user_id')
</pre>

<p>
For checking if a user is logged in (A decorator <code>requires_auth</code> for the same is defined in <code>app/__init__.py</code>) -
</p>
<pre class="example">
if 'user_id' not in session:
    return jsonify(message="Unauthorized", success=False), 401
</pre>

<p>
Hence to prevent certain users from certain routes all we need to do is mention <code>@requires_auth</code> and it will return a 401 response status
for users who are not authorized to view that page.
</p>

<p>
Examples of the usage can be found in <code>app/todo/controllers.py</code>
</p>
</div>
</div>

<div id="outline-container-org556f94c" class="outline-2">
<h2 id="org556f94c"><span class="section-number-2">5</span> Routing</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org62a556f" class="outline-3">
<h3 id="org62a556f"><span class="section-number-3">5.1</span> routes.js</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Sample route explanation -
</p>

<pre class="example">
page('/todo/create', authManager.requiresAuthentication, todoManager.create);
</pre>

<ul class="org-ul">
<li>This says if a request is received on <code>/todo/create</code>, then execute authManager.requiresAuthentication first and then todoManager.create
The thing to note here is that this list of callbacks can be terminated at any particular function i.e. our goal is to restrict access to todoManager based on user is logged in or not.</li>
</ul>

<pre class="example">
var requiresAuthentication = function(ctx, next) {
    getLoginState(function (state) {
        if (state &amp;&amp; state.loggedIn) {
            next();
        } else {
            intendedPath = ctx.path;
            //showLogin();
            page('/login');
        }
    });
};
</pre>

<ul class="org-ul">
<li>The next is a callback calling of which will result in execution of <code>todoManager.create</code>, if the user is not logged in then he/she will be redirected to '/login' after saving the current path in <code>intendedPath</code>.</li>

<li>This intendedPath will be used for redirecting a user after successful login.</li>
</ul>

<pre class="example">
var loggedIn = function (user) {
    loginState = {};
    loginState.loggedIn = true;
    loginState.user = user;
    page(intendedPath ? intendedPath : '/');
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org1063b07" class="outline-2">
<h2 id="org1063b07"><span class="section-number-2">6</span> Problems</h2>
<div class="outline-text-2" id="text-6">
<p>
Good news - No problems for today ! Party ;)</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: VLEAD</p>
<p class="date">Created: 2017-04-27 Thu 03:32</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
